<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>goodrad.io</title>
    <link type="text/css" rel="stylesheet" href="/assets/css/site.css" />
  </head>
  <body>
    <h1>goodrad.io<span class="condensed">﹚﹚﹚<span></h1>
    <div id="stations">
    : for $monitor.stations -> $station {
    <div class="station" id="station-<: $station.name :>" data-station="<: $station.name :>">
      <h2><: $station.name :> <span class="buttons"><span class="button paused"></span></span></h2>
      <ol class="plays"></ol>
    </div>
    : }
    </div>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/js/sprintf.min.js"></script>
    <script type="text/javascript">
      (function(data) {
        var playing = null;

        function add_plays (station, plays) {
          var container = $('#station-' + station);
          var list = container.find("ol.plays");
          var html = "";

          $(plays).each(function(i, play) {
            var id = "play-" + play.hash;
            if ($(id).length) return;
            var date = new Date(play.timestamp * 1000);
            var info = [];
            $(["artist", "title"]).each(function(i,field) {
              if (play[field]) info.push(play[field]);
            });

            html += sprintf("<li id='%s'>", id);
            if (play.timestamp) {
              html += sprintf("<span class='timestamp'>%02d:%02d</span>", date.getHours(), date.getMinutes());
            }
            html += sprintf(" %s</li>", info.join(" – "));
          });

          list.html(html);
        }

        $(data).each(function(i, update) {
          add_plays(update.station, update.plays);
        });

        var plays = new EventSource("/plays");
        plays.addEventListener("message", function(e) {
          var data = JSON.parse(e.data);
          add_plays(data.station, data.plays);
        });

        $('.station').on('click', '.paused,.error', function(e) {
          e.preventDefault();
          if (playing) playing.pause();
          $('.playing').removeClass('playing').addClass("paused");
          $('.active').removeClass('active');
          var button = $(this);
          var station = button.parents(".station");
          var name = station.attr('data-station');

          button.removeClass("paused playing error").addClass("loading");

          $.ajax({
            url: "/token",
            type: "GET",
            data: { station: name },
            success: function(token) {
              var src = sprintf("/play?token=%s&station=%s", token, name);
              playing = new Audio(src);

              var record = $('<span/>',{
                'class': 'button record',
                'data-listen-token': token
              });

              playing.addEventListener("playing", function(e) {
                button.removeClass("paused loading error").addClass("playing");
                button.before(record);
                station.addClass("active");
              });

              playing.addEventListener("error", function(e) {
                record.remove();
                // we empty src to stop, which throws an error
                if (playing.src == src)
                  button.removeClass("playing loading").addClass("error");
              });

              playing.play();
            }
          });
            
        });

        $('.station').on('click', '.recording', function(e) {
          var button = $(this);
          button.removeClass("recording").addClass("record");
          $.ajax({
            url: "/record/stop",
            type: "GET",
            data: {
              station: button.parents(".station").attr("data-station"),
              token: button.attr('data-listen-token')
            },
            success: function (download) {
              if (!download) return;
              $('body').append($('<iframe/>', {
                'src': download,
                'class': 'download'
              }));
            }
          });
        });

        $('.station').on('click', '.record', function(e) {
          var button = $(this);
          button.removeClass("record").addClass("recording");
          $.ajax({
            url: "/record/start",
            type: "GET",
            data: {
              station: button.parents(".station").attr("data-station"),
              token: button.attr('data-listen-token')
            }
          });
        });

        $('.station').on('click', '.playing,.loading', function(e) {
          e.preventDefault();
          if (playing) {
            playing.pause();
            playing.src = "";
            $(this).removeClass("playing error loading").addClass("paused");
            $(this).parents('.station').removeClass('active');
          }
        });

        $('.station').on('mousedown', '.button', function(e) {
          $(this).addClass("active");
        });

        $('.station').on('mouseup', '.button', function(e) {
          $(this).removeClass("active");
        });
      })(<: $data :>);
    </script>
  </body>
</html>
